<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Control</title>
    <style>
        /* (Gi·ªØ nguy√™n ph·∫ßn CSS c·ªßa b·∫°n) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            font-size: 14px;
            position: relative;
            overflow-y: auto;
        }
        .container {
            max-width: 393px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            padding-top: 110px;
        }
        .header {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 5px 10px;
            color: #000;
            height: 60px;
            position: fixed;
            top: 40px;
            left: 0;
            z-index: 10;
            border: none;
            box-shadow: none;
        }
        .header .icon-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
            margin-bottom: 2px;
        }
        .header .back {
            font-size: 25px;
            cursor: pointer;
            padding-left: 25px;
        }
        .header .title {
            font-size: 30px;
            font-weight: bold;
            font-style: italic;
            text-align: center;
            width: 100;
        }
        .header .home {
            font-size: 25px;
            cursor: pointer;
            padding-right: 35px;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 10px;
            width: 100%;
            max-width: 360px;
            margin:120px auto 20px;
            padding: 0 10px;
            box-sizing: border-box;
            border: none;
            display: none;
        }
        .device-grid.active {
            display: grid;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 180px;
            box-sizing: border-box;
            transition: all 0.3s;
            border: 1px solid #000;
            border-radius: 15px;
            position: relative;
        }
        .card.active {
            background: #007aff;
            color: #fff;
            border: none;
        }
        .card .icon {
            font-size: 30px;
            margin-bottom: 8px;
            text-align: center;
        }
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: auto;
        }
        .card-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: auto;
        }
        .device-type {
            font-size: 22px;
            font-weight: 600;
            margin: 0 0 2px 0;
            word-wrap: break-word;
        }
        .device-brand {
            font-size: 18px;
            color: #8e8e93;
            margin: 0;
            word-wrap: break-word;
        }
        .card.active .device-brand {
            color: rgba(255,255,255,0.8);
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e5e7;
            transition: 0.4s;
            border-radius: 12px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: #fff;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input:checked + .toggle-slider {
            background-color: #669BF7;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: #fff;
        }
        .add-device-form {
            width:320px;
            height: auto;
            padding: 20px;
            background-color: #BFECF5;
            border-radius: 12px;
            margin: 20px 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
            position: relative;
            top: 100px;
        }
        .add-device-form.active {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .form-group:first-child {
            margin-top: 0;
        }
        .form-group label {
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }
        /* Style cho Dropdown */
        .form-group select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            outline: none;
        }
        .form-group input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            outline: none;
        }
        .form-group input:focus {
            border-color: #007aff;
        }
        .buttons {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            flex: 1;
            transition: background-color 0.3s;
        }
        .btn-save {
            background-color: #DD1010;
            color: #ffffff;
        }
        .btn-save:hover {
            background-color: #f57e7e;
        }
        .btn-cancel {
            background-color: #4CAF50;
            color: #fff;
        }
        .btn-cancel:hover {
            background-color: #45a049;
        }
        .add-btn {
            width: 60px;
            height: 60px;
            background: #C0DBF3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgb(0, 0, 0);
            font-size: 18px;
            font-weight: bold;
            line-height: 60px;
            text-align: center;
            text-decoration: none;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 20px;
            box-shadow: 0 6px 12px rgba(192, 219, 243, 0.4);
            border: none;
            transition: opacity 0.3s;
            z-index: 5;
            display: block;
        }
        .add-btn.hidden {
            display: none;
        }
        .add-btn:hover {
            opacity: 0.8;
        }
        .delete-btn {
    position: absolute; /* ƒê·∫∑t n√∫t ·ªü v·ªã tr√≠ tuy·ªát ƒë·ªëi */
    top: 5px;
    right: 5px;
    width: 25px;
    height: 25px;
    background: #DD1010; /* M√†u ƒë·ªè n·ªïi b·∫≠t */
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    line-height: 25px;
    text-align: center;
    padding: 0;
    z-index: 2; /* ƒê·∫£m b·∫£o n√∫t n·∫±m tr√™n toggle switch */
    transition: background 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.delete-btn:hover {
    background: #f57e7e;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon-row">
                <span class="back" onclick="goHome()">&lt;</span>
                <span class="home">üè†</span>
            </div>
            <span class="title" id="main-title">Devices Control</span>
        </div>
        
        
        <div class="device-grid active" id="device-list">
            
            <div class="card active" data-device-id='69313a7d27fa074d0ad13d65'>
                <button class="delete-btn"></button>
                <div class="top-row">
                    <span class="icon">üí°</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked onchange="toggleSwitch(this, '69313a7d27fa074d0ad13d65')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="card-content">
                    <div class="device-type">Light bulbs</div>
                    <div class="device-brand">Philips Hue</div>
                </div>
            </div>
            
            <div class="card" data-device-id="2">
                <button class="delete-btn"></button>
                <div class="top-row">
                    <span class="icon">üì∫</span>
                    <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleSwitch(this, 2)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="card-content">
                    <button class="delete-btn"></button>
                    <div class="device-type">Smart TV</div>
                    <div class="device-brand">Panasonic</div>
                </div>
            </div>
            
            <div class="card" data-device-id="3">
                <button class="delete-btn"></button>
                <div class="top-row">
                    <span class="icon">üì∂</span>
                    <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleSwitch(this, 3)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="card-content">
                    <button class="delete-btn"></button>
                    <div class="device-type">Wi-Fi Router</div>
                    <div class="device-brand">TP Link</div>
                </div>
            </div>
            
            <div class="card" data-device-id="4">
                <button class="delete-btn"></button>
                <div class="top-row">
                    <span class="icon">üìπ</span>
                    <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleSwitch(this, 4)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="card-content">
                    <button class="delete-btn"></button>
                    <div class="device-type">CCTV</div>
                    <div class="device-brand">Security Camera 360¬∞</div>
                </div>
            </div>

            </div>
        
        <div class="add-device-form" id="add-form">
            <div class="form-group">
                <label for="device-type">Device Type</label>
                <select id="device-type">
                    <option value="Light">Light (ƒê√®n)</option>
                    <option value="Fan">Fan (Qu·∫°t)</option>
                    <option value="TV">Smart TV</option>
                    <option value="CCTV">Camera</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="device-id">Adafruit Feed Key (T√™n Feed duy nh·∫•t)</label>
                <input type="text" id="device-id" placeholder="V√≠ d·ª•: fan_bedroom_1" />
            </div>

            <div class="buttons" style="margin-top: 20px;">
                <button class="btn btn-save" onclick="saveDevice()">Save</button>
                <button class="btn btn-cancel" onclick="cancelAdd()">Cancel</button>
            </div>
        </div>
        <a href="#" class="add-btn" onclick="showAddForm()">Add</a>
    </div>
    
    <script src="//cdn.socket.io/4.5.1/socket.io.min.js"></script>
    
    <script>
        // --- ID C·ªê ƒê·ªäNH L·∫§Y T·ª™ data.txt C·ª¶A B·∫†N ---
        var HOME_ID_STATIC = "68d6cc199a93a8f1c5499fa8"; 
        var USER_ID_STATIC = "69313a731565f8757e2591cc"; 
        var currentRoomId = "69313a6c6aece782e037afa7"; // M·∫∑c ƒë·ªãnh Living Room

        // Danh s√°ch ID thi·∫øt b·ªã STATIC ƒë·ªÉ tr√°nh v·∫Ω l·∫°i
        const STATIC_DEVICE_IDS = [
            '69313a7d27fa074d0ad13d65', // LED ƒë√£ fix
            '2', 
            '3', 
            '4'
        ];

        // 1. H√†m ch·ªçn ph√≤ng (C·∫≠p nh·∫≠t currentRoomId v√† RENDER L·∫†I)
        function selectRoom(tabElement, roomId) {
            document.querySelectorAll('.nav-tabs span').forEach(span => span.classList.remove('active'));
            tabElement.classList.add('active');
            currentRoomId = roomId;
            console.log("ƒê√£ ch·ªçn ph√≤ng:", tabElement.innerText, "ID:", roomId);
            // G·ªåI H√ÄM RENDER L·∫†I THEO PH√íNG M·ªöI
            fetchDevicesAndRender(); 
        }

        // -------------------------------------------------------------
        // H√ÄM CH√çNH: L·∫§Y THI·∫æT B·ªä ƒê·ªòNG T·ª™ MONGO V√Ä V·∫º ·ªû D∆Ø·ªöI C√ôNG
        // -------------------------------------------------------------
        async function fetchDevicesAndRender() {
            try {
                const gridContainer = document.getElementById('device-list'); 
                if (!gridContainer) return;
                
                // L·∫•y t·∫•t c·∫£ c√°c th·∫ª STATIC hi·ªán c√≥ ƒë·ªÉ x√≥a c√°c th·∫ª DYNAMIC c≈©
                const staticCards = gridContainer.querySelectorAll('.card');
                
                // X√≥a t·∫•t c·∫£ c√°c th·∫ª card KH√îNG n·∫±m trong danh s√°ch STATIC_DEVICE_IDS
                staticCards.forEach(card => {
                    const deviceId = card.getAttribute('data-device-id');
                    if (!STATIC_DEVICE_IDS.includes(deviceId)) {
                        card.remove();
                    }
                });

                // 1. G·ªçi API Backend
                const response = await fetch('http://localhost:3000/api/devices');
                const devices = await response.json();

                // 2. Duy·ªát v√† Render thi·∫øt b·ªã
                devices.forEach(device => {
                    // B·ªé QUA thi·∫øt b·ªã STATIC (v√¨ n√≥ ƒë√£ c√≥ s·∫µn trong HTML)
                    if (STATIC_DEVICE_IDS.includes(device._id)) return; 
                    
                    // CH·ªà V·∫º THI·∫æT B·ªä DYNAMIC c·ªßa ph√≤ng ƒëang ch·ªçn
                    if (device.RoomID !== currentRoomId) return; 

                    const isActive = device.Device_status === 'ON' || device.Status === true;
                    const activeClass = isActive ? 'active' : '';
                    const icon = device.Type === 'Light' ? 'üí°' : 
                                 device.Type === 'Fan' ? 'üå¨Ô∏è' : 
                                 device.Type === 'TV' ? 'üì∫' : '‚öôÔ∏è';
                    
                    // 3. T·∫°o th·∫ª HTML (Card)
                    const cardHTML = `
                        <div class="card ${activeClass}" data-device-id='${device._id}'>
                            <button class="delete-btn" onclick="deleteDevice('${device._id}', this)">√ó</button>
                            <div class="top-row">
                                <span class="icon">${icon}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleSwitch(this, '${device._id}')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="card-content">
                                <div class="device-type">${device.Device_name}</div>
                                <div class="device-brand">Feed: ${device.AIO_FeedID}</div>
                            </div>
                        </div>
                    `;

                    gridContainer.innerHTML += cardHTML; // TH√äM V√ÄO CU·ªêI KH·ªêI HI·ªÜN T·∫†I
                });
                
                // Hi·ªán l·∫°i l∆∞·ªõi thi·∫øt b·ªã (Sau khi t·∫£i xong)
                document.querySelector('.device-grid').classList.add('active');

            } catch (error) {
                console.error("L·ªói khi t·∫£i thi·∫øt b·ªã:", error);
            }
        }

        // 2. H√†m X√ìA THI·∫æT B·ªä
async function deleteDevice(deviceId, element) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thi·∫øt b·ªã ${deviceId} kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
        return; 
    }

    try {
        const response = await fetch(`http://localhost:3000/api/devices/${deviceId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // X√≥a th√†nh c√¥ng, c·∫≠p nh·∫≠t giao di·ªán
            alert(`‚úÖ ƒê√£ x√≥a thi·∫øt b·ªã ${deviceId} th√†nh c√¥ng.`);
            
            // X√≥a th·∫ª thi·∫øt b·ªã kh·ªèi DOM
            const cardElement = element.closest('.card');
            if (cardElement) {
                cardElement.remove();
            }

            // Ho·∫∑c g·ªçi l·∫°i h√†m v·∫Ω ƒë·ªÉ l√†m m·ªõi ho√†n to√†n
            // fetchDevicesAndRender(); 
            
        } else {
            const data = await response.json();
            alert("‚ùå L·ªói Server khi x√≥a: " + (data.message || "Kh√¥ng x√≥a ƒë∆∞·ª£c."));
        }
    } catch (error) {
        console.error("L·ªói k·∫øt n·ªëi Backend:", error);
        alert("‚ùå L·ªói k·∫øt n·ªëi. Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu x√≥a.");
    }
}

        // 3. H√†m L∆∞u thi·∫øt b·ªã TH·∫¨T (G·ª≠i d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß v·ªÅ Backend)
        async function saveDevice() {
            const type = document.getElementById('device-type').value;
            const feedId = document.getElementById('device-id').value;
            
            if (!feedId || feedId === "" || !type) {
                alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn Device Type v√† Nh·∫≠p Adafruit Feed Key!");
                return;
            }

            const payload = {
                Device_type: type,
                AIO_FeedID: feedId,
                
                // T·ª± ƒë·ªông ƒëi·ªÅn ID c·ªë ƒë·ªãnh
                HomeID: HOME_ID_STATIC,
                UserID: USER_ID_STATIC, 
                RoomID: currentRoomId, // L·∫•y RoomID t·ª´ tab ƒëang active
            };
            
            // Theo quy t·∫Øc c·ªßa b·∫°n: Device_name = Device_type
            payload.Device_name = type; 

            try {
                console.log("ƒêang g·ª≠i:", payload);
                
                const response = await fetch('http://localhost:3000/api/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert(`‚úÖ ƒê√£ th√™m thi·∫øt b·ªã th√†nh c√¥ng!`);
                    cancelAdd(); // ·∫®n form
                    await fetchDevicesAndRender(); // V·∫º L·∫†I UI ƒê·ªÇ HI·ªÜN THI·∫æT B·ªä M·ªöI
                } else {
                    const data = await response.json();
                    alert("‚ùå L·ªói Server: " + (data.message || "Kh√¥ng l∆∞u ƒë∆∞·ª£c"));
                }
            } catch (error) {
                console.error("L·ªói k·∫øt n·ªëi:", error);
                alert("‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Backend Node.js (Port 3000).");
            }
        }
        
        // 3. H√†m b·∫≠t/t·∫Øt thi·∫øt b·ªã (G·ª≠i l·ªánh t·ªõi Backend)
        function toggleSwitch(checkbox, deviceId) {
            const card = checkbox.closest('.card');
            const isActive = checkbox.checked;
            if (isActive) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
            console.log(`Device updated to ${isActive ? 'ON' : 'OFF'} by toggle`);

            fetch("/toggle_device", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: deviceId, state: isActive })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    console.log(`Server updated device ${deviceId} successfully`);
                } else {
                    console.error(`Failed to update device ${deviceId}:`, data.message);
                }
            })
            .catch(err => console.error("Error sending toggle:", err));
        }

        // 4. C√°c h√†m UI c∆° b·∫£n
        function showAddForm() {
            document.getElementById('device-list').classList.remove('active');
            document.getElementById('add-form').classList.add('active');
            document.getElementById('main-title').textContent = 'Add Device';
            document.querySelector('.add-btn').classList.add('hidden');
        }

        function cancelAdd() {
            document.getElementById('add-form').classList.remove('active');
            document.getElementById('device-list').classList.add('active');
            document.getElementById('main-title').textContent = 'Devices Control';
            document.querySelector('.add-btn').classList.remove('hidden');
            // Reset form
            document.getElementById('device-type').value = 'Light';
            document.getElementById('device-id').value = '';
        }

        function goHome() {
            window.location.href = "/";
        }
        
        // G·ªåI H√ÄM V·∫º THI·∫æT B·ªä KHI TRANG T·∫¢I XONG
        document.addEventListener('DOMContentLoaded', () => {
            // Hi·ªÉn th·ªã l∆∞·ªõi thi·∫øt b·ªã v√† ·∫©n form th√™m thi·∫øt b·ªã khi t·∫£i trang
            document.getElementById('device-list').classList.add('active');
            document.getElementById('add-form').classList.remove('active');
            fetchDevicesAndRender();
        });
    </script>
    
    <script>
        const socket = io('http://127.0.0.1:5000');
        socket.on('deviceUpdated', (device) => {
            console.log('Device updated:', device);
            const el = document.querySelector(`[data-device-id="${device.id}"]`);
            if (el) {
                const checkbox = el.querySelector('input[type="checkbox"]');
                checkbox.checked = device.state;
                if(device.state){
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>