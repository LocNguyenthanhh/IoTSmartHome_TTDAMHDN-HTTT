<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    <style>
        /* CSS Ä‘Æ°á»£c giá»¯ nguyÃªn */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .home-btn {
            width: 40px;
            height: 40px;
            background: #f3f4f6;
            color: #1f2937;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        .period-tabs {
            background: white;
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            overflow-x: auto;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 72px;
            z-index: 99;
        }

        .period-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            background: #f3f4f6;
            color: #6b7280;
            border: none;
        }

        .period-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .content {
            padding: 24px;
        }

        .energy-card {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.3);
            color: white;
        }

        .energy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .energy-label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }

        .energy-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .energy-value {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 16px;
        }

        .energy-value h1 {
            font-size: 48px;
            font-weight: 700;
        }

        .energy-value span {
            font-size: 20px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .energy-details {
            display: flex;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .energy-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .energy-detail-text {
            font-size: 13px;
        }

        .energy-detail-value {
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.blue { background: #dbeafe; color: #2563eb; }
        .stat-icon.green { background: #dcfce7; color: #16a34a; }
        .stat-icon.orange { background: #fed7aa; color: #ea580c; }
        .stat-icon.red { background: #fee2e2; color: #dc2626; }

        .stat-trend {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        .stat-trend.down {
            background: #dcfce7;
            color: #16a34a;
        }

        .stat-trend.up {
            background: #fee2e2;
            color: #dc2626;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }

        .chart-btn {
            width: 40px;
            height: 40px;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }

        .chart-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .chart-btn:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }

        .chart-container {
            position: relative;
            height: 300px; /* CÃ¢n báº±ng kÃ­ch thÆ°á»›c */
        }

        .line-chart-container {
            position: relative;
            height: 220px;
            padding: 10px 0;
        }

        .chart-current-value {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Remove unused usage list CSS */
        .device-usage-card, .usage-title, .usage-list, .usage-item, .usage-icon, .usage-info, .usage-name, .usage-bar-container, .usage-bar-bg, .usage-bar-fill, .usage-percentage {
            display: none; /* áº¨n toÃ n bá»™ pháº§n Device Usage Breakdown */
        }

        .tips-card {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .tips-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .tips-icon {
            width: 36px;
            height: 36px;
            background: #16a34a;
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .tips-title {
            font-size: 15px;
            font-weight: 600;
            color: #166534;
        }

        .tips-text {
            font-size: 13px;
            color: #166534;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 class="header-title">Analytics</h1>
            </div>
            <div class="header-left">
                <button class="home-btn" onclick="goHome()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        

        <div class="content">
            <div class="energy-card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="energy-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="energy-label">Total Energy Consumption</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="energy-icon">âš¡</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="energy-value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 id="total-energy-kwh">0.0000</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>kWh</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Real-time Power Monitor</div>
                </div>
                <div class="line-chart-container">
                    <canvas id="lineChart"></canvas>
                    <div class="chart-current-value" id="currentValue">0.0 kW</div>
                </div>
            </div>

            <div class="tips-card">
                <div class="tips-header">
                    <div class="tips-icon">ğŸ’¡</div>
                    <div class="tips-title">Energy Saving Tip</div>
                </div>
                <div class="tips-text">
                    Your AC is consuming 45% of total energy. Try setting the temperature to 24-26Â°C to reduce consumption by up to 20%. You could save approximately $3.74 per week!
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cáº¥u hÃ¬nh cá»©ng cho viá»‡c tÃ­nh toÃ¡n
        const POWER_KW = 2.5; // cÃ´ng suáº¥t giáº£ Ä‘á»‹nh khi ON
        const PRICE_PER_KWH = 0.12; // giÃ¡ giáº£ Ä‘á»‹nh

        let currentPeriod = 'week';
        let currentChartType = 'bar';
        let energyChartInstance = null; // Biáº¿n Ä‘á»ƒ lÆ°u instance cá»§a chart
        let dialogHistory = []; // Lá»‹ch sá»­ Ä‘áº§y Ä‘á»§ cho tÃ­nh toÃ¡n

        // HÃ m giáº£ láº­p láº¥y dá»¯ liá»‡u thá»‘ng kÃª cho tuáº§n trÆ°á»›c
        function getPreviousPeriodData(period) {
            // á» Ä‘Ã¢y, chÃºng ta giáº£ láº­p má»™t sá»± so sÃ¡nh:
            switch(period) {
                case 'today': return { totalEnergy: 40 }; 
                case 'week': return { totalEnergy: 250 }; 
                case 'month': return { totalEnergy: 1000 }; 
                case 'year': return { totalEnergy: 12000 }; 
                default: return { totalEnergy: 0 };
            }
        }

        // ====================================================================
        // LOGIC TÃNH TOÃN CHÃNH (Sá»­ dá»¥ng lá»‹ch sá»­ dialog)
        // ====================================================================
        function calculateAnalytics(list, period) {
            const today = new Date();
            let startMs, endMs;
            
            // 1. XÃ¡c Ä‘á»‹nh KHUNG THá»œI GIAN
            endMs = today.getTime();
            
            // Láº¥y dá»¯ liá»‡u tá»« 00:00:00 ngÃ y hÃ´m nay náº¿u chá»n 'today'
            if (period === 'today') {
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                startMs = todayStart.getTime();
            } else if (period === 'week') {
                startMs = endMs - (7 * 24 * 60 * 60 * 1000); 
            } else if (period === 'month') {
                startMs = endMs - (30 * 24 * 60 * 60 * 1000); 
            } else if (period === 'year') {
                startMs = endMs - (365 * 24 * 60 * 60 * 1000); 
            } else {
                startMs = 0;
            }

            let onMs = 0;
            
            // Äáº£o ngÆ°á»£c danh sÃ¡ch Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh toÃ¡n tá»« CÅ¨ NHáº¤T -> Má»šI NHáº¤T
            const reversedList = [...list].reverse(); 

            // 2. TÃ­nh toÃ¡n thá»i gian ON
            for (let i = 1; i < reversedList.length; i++) {
                const prev = reversedList[i - 1];
                const cur = reversedList[i];

                const tPrev = new Date(prev.time).getTime();
                const tCur = new Date(cur.time).getTime();
                
                // Bá» qua cÃ¡c sá»± kiá»‡n quÃ¡ cÅ© so vá»›i khung thá»i gian
                if (tCur < startMs) continue; 
                
                // delta lÃ  khoáº£ng thá»i gian (tCur luÃ´n lá»›n hÆ¡n tPrev do Ä‘Ã£ reverse)
                const delta = Math.max(0, tCur - tPrev);

                // Náº¿u tráº¡ng thÃ¡i TRÆ¯á»šC (prev) lÃ  ON, cá»™ng thá»i gian hoáº¡t Ä‘á»™ng
                const prevOn = (prev.status === "ON" || prev.status === true);
                if (prevOn) {
                    onMs += delta;
                }
            }

            // 3. TÃ­nh toÃ¡n káº¿t quáº£ cuá»‘i cÃ¹ng
            const onHours = onMs / (1000 * 60 * 60);
            const currentPeriodKwh = onHours * POWER_KW;


            // 4. TÃ­nh toÃ¡n So sÃ¡nh (Giá»¯ nguyÃªn logic giáº£ láº­p)
            const previousData = getPreviousPeriodData(period);
            const previousKwh = previousData.totalEnergy;
            let comparison = 0;
            let trend = 'â€”';
            let trendClass = '';

            if (previousKwh > 0) {
                comparison = ((currentPeriodKwh - previousKwh) / previousKwh) * 100;
                trend = comparison.toFixed(0) + '%';
                trendClass = comparison < 0 ? 'down' : 'up';
            }


            // 5. Chuáº©n bá»‹ Chart Data
            const chartData = [];
    if (period === 'week') {
        const dailyRunTimeMs = Array(7).fill(0); 
        const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // --- Báº¯t Ä‘áº§u tÃ­nh toÃ¡n Tá»«ng Thiáº¿t bá»‹ ---

        // Láº·p qua lá»‹ch sá»­ dialog (sáº¯p xáº¿p theo thá»i gian)
        const sortedHistory = list.sort((a, b) => new Date(a.Time).getTime() - new Date(b.Time).getTime());

        // Map lÆ°u tráº¡ng thÃ¡i báº­t cuá»‘i cÃ¹ng cá»§a má»—i thiáº¿t bá»‹: { deviceId: lastOnTime }
        const lastOnTimes = {}; 
        
        for (const entry of sortedHistory) {
            const entryTime = new Date(entry.Time || entry.time);
            const deviceId = entry.DeviceID; 
            const isEntryOn = (entry.Status_history === "ON" || entry.status === "ON" || entry.status === true);
            const powerW = deviceMap[deviceId] || 60; // Láº¥y cÃ´ng suáº¥t tá»« Map

            // Bá» qua sá»± kiá»‡n quÃ¡ cÅ©
            if (entryTime.getTime() < startMs) {
                if (isEntryOn) { lastOnTimes[deviceId] = entryTime; }
                continue;
            }

            if (isEntryOn) {
                lastOnTimes[deviceId] = entryTime;
            } else if (!isEntryOn && lastOnTimes[deviceId]) {
                // Sá»± kiá»‡n Táº®T trong khung 7 ngÃ y vÃ  Ä‘Ã£ cÃ³ thá»i Ä‘iá»ƒm Báº¬T
                let effectiveOnTime = lastOnTimes[deviceId].getTime();
                if (effectiveOnTime < startMs) {
                    effectiveOnTime = startMs; // Giá»›i háº¡n láº§n báº­t Ä‘áº§u tiÃªn
                }
                
                let durationMs = entryTime.getTime() - effectiveOnTime;
                
                // PhÃ¢n bá»• thá»i gian cháº¡y vÃ o tá»«ng ngÃ y (Logic phá»©c táº¡p hÆ¡n)
                let currentTimePointer = new Date(effectiveOnTime);
                
                while (durationMs > 0) {
                    const endOfDay = new Date(currentTimePointer);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    const timeRemainingInDay = endOfDay.getTime() - currentTimePointer.getTime();
                    const runInDay = Math.min(durationMs, timeRemainingInDay);
                    
                    // XÃ¡c Ä‘á»‹nh Index ngÃ y trong tuáº§n (Mon=0, Sun=6)
                    let dayIndex = (currentTimePointer.getDay() - 1 + 7) % 7; 
                    
                    // TÃNH TOÃN KWH TRá»°C TIáº¾P
                    const runHours = runInDay / 3600000;
                    const dailyKwhContribution = (runHours * powerW) / 1000;
                    
                    dailyRunTimeMs[dayIndex] += dailyKwhContribution; // TÃ­ch lÅ©y KWH
                    
                    durationMs -= runInDay;
                    currentTimePointer = new Date(endOfDay.getTime() + 1);
                }

                delete lastOnTimes[deviceId]; // Reset sau khi táº¯t
            }
        }
        
        // Chuyá»ƒn Ä‘á»•i run time (ms) thÃ nh kWh cho tá»«ng ngÃ y
        dailyRunTimeMs.forEach((kwh, index) => {
            // TÃNH TOÃN WH (Wh = kWh * 1000)
            const dailyWh = kwh * 1000;
            chartData.push({ label: daysOfWeek[index], value: parseFloat(kwh.toFixed(4)) });
        });

        // --- Káº¿t thÃºc tÃ­nh toÃ¡n ---
    
    
    // Chuyá»ƒn Ä‘á»•i run time (ms) thÃ nh kWh cho tá»«ng ngÃ y
    dailyRunTimeMs.forEach((ms, index) => {
        const runHours = ms / (1000 * 60 * 60);
        const dailyKwh = (runHours * POWER_KW) / 1000;
        
        // Äáº£m báº£o khÃ´ng quÃ¡ nhá» (vÃ­ dá»¥ 0.0001 kWh)
        const displayKwh = Math.max(0, dailyKwh); 
        
        chartData.push({ label: daysOfWeek[index], value: displayKwh });
    });

    // === Káº¾T THÃšC Sá»¬A LOGIC TÃNH TOÃN THEO NGÃ€Y ===
}

            return {
                totalEnergy: currentPeriodKwh,
                activeTime: onHours,
                comparison: comparison,
                trend: trend,
                trendClass: trendClass,
                chartData: chartData,
                chartTitle: period.charAt(0).toUpperCase() + period.slice(1) + ' Energy Usage',
                avgTemp: 20 + Math.floor(Math.random() * 5)
            };
        }

        // ====================================================================
        // UPDATE UI
        // ====================================================================
        function updateUI(period, calculatedData) {
    const data = calculatedData;
    
    // --- Xá»­ lÃ½ giÃ¡ trá»‹ NaN/Undefined/Ã‚m --- (GIá»® NGUYÃŠN)
    let energyValue = calculatedData.totalEnergy;
    if (isNaN(energyValue) || !isFinite(energyValue) || energyValue < 0) { 
        energyValue = 0; 
    }
    
    let activeTimeValue = calculatedData.activeTime;
    if (isNaN(activeTimeValue) || !isFinite(activeTimeValue) || activeTimeValue < 0) {
        activeTimeValue = 0;
    }
    // ---------------------------------------

    // Cáº­p nháº­t Total Energy Card (Sá»¬A Lá»–I Äá»ŠNH Dáº NG Sá»)
    let displayEnergy;
    if (energyValue === 0) {
        displayEnergy = "0";
    } else if (energyValue < 10) { 
        displayEnergy = energyValue.toFixed(1);
    } else {
        displayEnergy = energyValue.toFixed(0); 
    }
    
    
    // Cáº­p nháº­t Chart (GIá»® Láº I)
    document.getElementById('chartTitle').textContent = data.chartTitle;
    updateChart(data.chartData);


    // áº¨n/Hiá»‡n nÃºt line chart (GIá»® Láº I VÃŒ CÃ“ THá»‚ Sá»¬ Dá»¤NG CHO CHART WEEKLY)
    const lineBtn = document.getElementById('lineBtn');
    if (period === 'today') {
        lineBtn.style.display = 'flex';
    } else {
        lineBtn.style.display = 'none';
        if (currentChartType === 'line') currentChartType = 'bar'; // Chuyá»ƒn vá» bar náº¿u line bá»‹ áº©n
    }
}


        function updateChart(chartData) {
            const ctx = document.getElementById('energyChart').getContext('2d');

            // Há»§y instance chart cÅ© náº¿u tá»“n táº¡i
            if (energyChartInstance) {
                energyChartInstance.destroy();
            }

            const labels = chartData.map(item => item.label);
            const values = chartData.map(item => item.value);

            let chartConfig = {};
            switch (currentChartType) {
                case 'bar':
                case 'line':
                    // Giá»¯ nguyÃªn Bar/Line chart configuration
                    const isLine = currentChartType === 'line';
                    chartConfig = {
                        type: isLine ? 'line' : 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Energy Usage (Wh)',
                                // Sá»­a lá»—i biá»ƒu Ä‘á»“ trá»‘ng: Ä‘áº£m báº£o giÃ¡ trá»‹ tá»‘i thiá»ƒu lÃ  0.1
                                data: values.map(v => Math.max(0.1, v)), 
                                fill: isLine ? true : false,
                                backgroundColor: isLine ? 'rgba(59, 130, 246, 0.2)' : 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(37, 99, 235, 1)',
                                borderWidth: isLine ? 2 : 1,
                                tension: isLine ? 0.4 : 0
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    ticks: {
                                            callback: function(value, index, ticks) {
                                            // Hiá»ƒn thá»‹ Wh thay vÃ¬ kWh
                                            return value + ' Wh'; 
                                                        }
                                            },
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            maintainAspectRatio: false
                        }
                    };
                    break;
                case 'doughnut':
                    // áº¨n Doughnut Chart
                    return;
            }

            // Táº¡o má»›i chart instance
            energyChartInstance = new Chart(ctx, chartConfig);
        }
        
        // Bá» hÃ m updateDeviceUsage

        async function fetchAndCalculate(period) {
            try {
                // 1. Fetch toÃ n bá»™ lá»‹ch sá»­ 
                const res = await fetch("http://127.0.0.1:5000/dialog_history");
                const history = await res.json();
                
                // 2. TÃ­nh toÃ¡n dá»±a trÃªn toÃ n bá»™ lá»‹ch sá»­ vÃ  khung thá»i gian yÃªu cáº§u
                const calculatedData = calculateAnalytics(history, period);
                
                // 3. Cáº­p nháº­t giao diá»‡n
                updateUI(period, calculatedData);
                
            } catch (error) {
                console.error("Error fetching analytics data:", error);
                document.getElementById('totalEnergy').textContent = 'Error';
            }
        }


        function changePeriod(targetButton, period) {
            currentPeriod = period;
            const tabs = document.querySelectorAll('.period-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Sá»­ dá»¥ng targetButton (lÃ  Ä‘á»‘i tÆ°á»£ng 'this' tá»« HTML) Ä‘á»ƒ active
            if (targetButton) {
                targetButton.classList.add('active'); 
            }

            fetchAndCalculate(period); // Gá»i fetch vÃ  tÃ­nh toÃ¡n láº¡i
        }


        function changeChartType(targetButton, type) {
            currentChartType = type;
            const buttons = document.querySelectorAll('.chart-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Chá»‰ cáº§n update UI/Chart, khÃ´ng cáº§n fetch láº¡i lá»‹ch sá»­ vÃ¬ dialogHistory Ä‘Ã£ sáºµn cÃ³
            const calculatedData = calculateAnalytics(dialogHistory, currentPeriod);
            updateUI(currentPeriod, calculatedData);
        }


        function goHome() {
         window.location.href = '/';
        }


        // ===== SOCKET REALTIME CHART & STATS =====
        const socket = io();
        const canvas = document.getElementById('lineChart');
        const ctx = canvas.getContext('2d');
        const currentValueDisplay = document.getElementById('currentValue');

        const maxDataPoints = 50;
        let dataPoints = Array(maxDataPoints).fill(0); // Khá»Ÿi táº¡o 50 Ä‘iá»ƒm 0

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function drawLineChart() {
            // (Logic váº½ LineChart Ä‘Ã£ Ä‘Æ°á»£c giá»¯ nguyÃªn)
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }

            ctx.fillStyle = '#9ca3af';
            ctx.font = '10px -apple-system';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height / 4) * i;
                const value = (4 - i) * 1.25;
                ctx.fillText(value.toFixed(1) + ' kW', padding - 10, y + 4);
            }

            if (dataPoints.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 3;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';

                const stepX = width / (maxDataPoints - 1);

                for (let i = 0; i < dataPoints.length; i++) {
                    const x = padding + i * stepX;
                    const normalizedValue = Math.max(0, Math.min(5, dataPoints[i]));
                    const y = padding + height - (normalizedValue / 5) * height;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                ctx.lineTo(canvas.width - padding, padding + height);
                ctx.lineTo(padding, padding + height);
                ctx.closePath();

                const gradient = ctx.createLinearGradient(0, padding, 0, padding + height);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                ctx.fillStyle = gradient;
                ctx.fill();

                const lastX = padding + (dataPoints.length - 1) * stepX;
                const lastValue = dataPoints[dataPoints.length - 1];
                const lastY = padding + height - (lastValue / 5) * height;

                ctx.beginPath();
                ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#3b82f6';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function pushRealtimeValueFromDialog(p) {
            const isOn = (p.status === "ON" || p.status === true);
            const newValue = isOn ? POWER_KW : 0.1; // DÃ¹ng POWER_KW tháº­t

            dataPoints.push(newValue);
            if (dataPoints.length > maxDataPoints) {
                dataPoints.shift();
            }

            currentValueDisplay.textContent = newValue.toFixed(2) + " kW";
            drawLineChart();
        }

        // TÃªn hÃ m cÅ©: updateStatsFromDialog
        function updateStatsFromDialog(list) {
            // Cáº­p nháº­t láº¡i cÃ¡c chá»‰ sá»‘ thá»‘ng kÃª tá»•ng thá»ƒ khi cÃ³ dá»¯ liá»‡u má»›i
            fetchAndCalculate(currentPeriod);
        }

        const DEVICE_LIST_URL = 'http://localhost:3000/api/devices';

        async function loadHistory() {
    try {
        // 1. Láº¥y danh sÃ¡ch thiáº¿t bá»‹ (vÃ  cÃ´ng suáº¥t)
        const deviceRes = await fetch(DEVICE_LIST_URL);
        const devices = await deviceRes.json();
        
        // Chuyá»ƒn danh sÃ¡ch thiáº¿t bá»‹ thÃ nh Map Ä‘á»ƒ tra cá»©u nhanh (ID -> PowerW)
        const deviceMap = devices.reduce((map, dev) => {
            map[dev._id] = dev.PowerConsumptionW || 60;
            return map;
        }, {});
        
        // 2. Láº¥y lá»‹ch sá»­ dialog
        const historyRes = await fetch("http://127.0.0.1:5000/dialog_history");
        const history = await historyRes.json();
        
        // 3. TÃ­nh toÃ¡n vÃ  cáº­p nháº­t
        const calculatedData = calculateAnalytics(history, 'week', deviceMap); // TRUYá»€N deviceMap VÃ€O
        updateUI('week', calculatedData); 

    } catch (error) {
        console.error("Error loading initial history for analytics:", error);
        document.getElementById('totalEnergy').textContent = 'Error';
    }
}

        socket.on("dialogUpdated", (p) => {
            console.log("dialogUpdated (Realtime):", p);
            dialogHistory.push(p);
            if (dialogHistory.length > 500) dialogHistory.shift(); 
            
            pushRealtimeValueFromDialog(p);
            updateStatsFromDialog(dialogHistory); // Cháº¡y láº¡i logic tÃ­nh toÃ¡n
        });

        window.addEventListener('load', () => {
            loadHistory();
            drawLineChart();
            // NÃºt "This Week" lÃ  nÃºt máº·c Ä‘á»‹nh active
            document.getElementById('barBtn').classList.add('active'); 
        });

        // ===== POWER MONITORING ANALYTICS API =====
Â  Â  Â  Â  const POWER_API_URL_BASE = 'http://localhost:3000/api/analytics/power';
Â  Â  Â  Â  
Â  Â  Â  Â  async function updatePowerMonitorFromAPI(period = 'week') { 
    // Máº·c Ä‘á»‹nh lÃ  'week' náº¿u khÃ´ng truyá»n tham sá»‘
    
    // 1. XÃ¢y dá»±ng URL vá»›i tham sá»‘ lá»c (filter)
    const filterParam = `?filter=${period}`;
    const API_URL = POWER_API_URL_BASE + filterParam;

    try {
        const response = await fetch(API_URL);
        const data = await response.json();

        if (response.ok) {
            // Cáº­p nháº­t Total Energy Consumption (kWh)
            // LÆ¯U Ã: Giá»¯ láº¡i 4 chá»¯ sá»‘ tháº­p phÃ¢n cho Ä‘á»™ chÃ­nh xÃ¡c cao khi tÃ­nh toÃ¡n nhá»
            const totalEnergykWh = data.totalEnergykWh.toFixed(4); 
            document.getElementById('total-energy-kwh').textContent = totalEnergykWh;
            
            // Cáº­p nháº­t Real-time Power Monitor (W)
            const currentPowerW = data.currentPowerW.toFixed(2);
            document.getElementById('realtime-power-w').textContent = currentPowerW + " W";
            
            // Cáº­p nháº­t Tráº¡ng thÃ¡i
            const status = data.currentPowerW > 0 ? 'Äang tiÃªu thá»¥' : 'Nghá»‰';
            document.getElementById('power-status').textContent = status;
            
            // console.log('Power Analytics API response:', data); // CÃ³ thá»ƒ báº­t Ä‘á»ƒ debug

        } else {
            console.error('API Error:', data.message);
        }
    } catch (error) {
        console.error('Error fetching power analytics:', error);
        document.getElementById('power-status').textContent = 'Lá»—i káº¿t ná»‘i';
    }
}

    window.addEventListener('load', () => {
    loadHistory(); 
    updatePowerMonitorFromAPI();
    setInterval(updatePowerMonitorFromAPI, 5000); 

});

    </script>
</body>
</html>